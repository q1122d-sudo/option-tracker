<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>期權記帳本</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- 核心庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PWA Manifest -->
    <link rel="manifest" id="my-manifest">
    <link rel="apple-touch-icon" href="" id="app-icon-ios">
    <link rel="icon" type="image/png" href="" id="app-icon">

    <style>
        body { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; overscroll-behavior-y: none; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); background-color: #f9fafb; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        header.sticky { top: env(safe-area-inset-top); }
    </style>

    <script>
        // 生成圖示
        const iconSvg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="128" fill="#2563eb"/><path d="M368 160H144c-17.6 0-32 14.4-32 32v224c0 17.6 14.4 32 32 32h224c17.6 0 32-14.4 32-32V192c0-17.6-14.4-32-32-32z" fill="none" stroke="white" stroke-width="32" stroke-linecap="round" stroke-linejoin="round"/><path d="M256 120v40M256 240v140" fill="none" stroke="white" stroke-width="32" stroke-linecap="round" stroke-linejoin="round"/><path d="M176 320l80-80 80 80" fill="none" stroke="white" stroke-width="32" stroke-linecap="round" stroke-linejoin="round"/></svg>`);
        const iconDataUri = `data:image/svg+xml,${iconSvg}`;
        document.getElementById('app-icon').href = iconDataUri;
        document.getElementById('app-icon-ios').href = iconDataUri;
        const manifest = { name: "期權記帳本", short_name: "期權記帳", start_url: ".", display: "standalone", background_color: "#f9fafb", theme_color: "#ffffff", orientation: "portrait", icons: [{ src: iconDataUri, sizes: "512x512", type: "image/svg+xml" }] };
        document.getElementById('my-manifest').href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 內建圖示組件 (解決外部依賴崩潰問題) ---
        const IconBase = ({ path, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{__html: path}} />
        );
        const Icons = {
            Plus: (p) => <IconBase {...p} path='<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>' />,
            TrendingUp: (p) => <IconBase {...p} path='<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline>' />,
            Trash2: (p) => <IconBase {...p} path='<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line>' />,
            X: (p) => <IconBase {...p} path='<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>' />,
            CheckCircle: (p) => <IconBase {...p} path='<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>' />,
            AlertCircle: (p) => <IconBase {...p} path='<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>' />,
            PieChart: (p) => <IconBase {...p} path='<path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path>' />,
            DollarSign: (p) => <IconBase {...p} path='<line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>' />,
            Calendar: (p) => <IconBase {...p} path='<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>' />,
            Edit: (p) => <IconBase {...p} path='<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>' />,
            Settings: (p) => <IconBase {...p} path='<circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>' />,
            Globe: (p) => <IconBase {...p} path='<circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>' />,
            RefreshCcw: (p) => <IconBase {...p} path='<polyline points="1 4 1 10 7 10"></polyline><polyline points="23 20 23 14 17 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>' />,
            ArrowRight: (p) => <IconBase {...p} path='<line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline>' />,
            ChevronDown: (p) => <IconBase {...p} path='<polyline points="6 9 12 15 18 9"></polyline>' />,
            ChevronRight: (p) => <IconBase {...p} path='<polyline points="9 18 15 12 9 6"></polyline>' />,
            Layers: (p) => <IconBase {...p} path='<polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline>' />,
            Shield: (p) => <IconBase {...p} path='<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>' />,
            LayoutList: (p) => <IconBase {...p} path='<rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>' />,
            BarChart2: (p) => <IconBase {...p} path='<line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line>' />,
            Download: (p) => <IconBase {...p} path='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>' />,
            Upload: (p) => <IconBase {...p} path='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>' />,
            FileJson: (p) => <IconBase {...p} path='<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line>' />,
            Tag: (p) => <IconBase {...p} path='<path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>' />,
            Wallet: (p) => <IconBase {...p} path='<path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path><path d="M4 6v12a2 2 0 0 0 2 2h14v-4"></path><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path>' />,
            Share: (p) => <IconBase {...p} path='<path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line>' />,
            Key: (p) => <IconBase {...p} path='<path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>' />
        };

        const { 
            Plus, TrendingUp, Trash2, X, CheckCircle, AlertCircle, PieChart, 
            DollarSign, Calendar, Clock, Edit, Settings, Globe, RefreshCcw, 
            ArrowRight, ChevronDown, ChevronRight, Layers, Shield, LayoutList, 
            BarChart2, Download, Upload, FileJson, Tag, Wallet, Share, Key 
        } = Icons;

        // --- 常數與設定 ---
        const DEFAULT_SETTINGS = {
            currency: { code: 'USD', symbol: '$', rate: 1, name: '美金 (原始)' },
            initialCapital: 10000,
            finnhubApiKey: ''
        };

        const CURRENCY_OPTIONS = [
            { code: 'USD', symbol: '$', name: '美金 (USD)', defaultRate: 1 },
            { code: 'TWD', symbol: 'NT$', name: '新台幣 (TWD)', defaultRate: 32.5 },
            { code: 'HKD', symbol: 'HK$', name: '港幣 (HKD)', defaultRate: 7.8 },
            { code: 'CNY', symbol: '¥', name: '人民幣 (CNY)', defaultRate: 7.2 },
            { code: 'JPY', symbol: '¥', name: '日圓 (JPY)', defaultRate: 150 },
        ];

        const STRATEGIES = [
            { id: 'LONG_CALL', label: 'Long Call' }, { id: 'LONG_PUT', label: 'Long Put' },
            { id: 'COVERED_CALL', label: 'Covered Call' }, { id: 'CASH_SECURED_PUT', label: 'Cash Secured Put' },
            { id: 'WHEEL', label: 'Wheel' }, { id: 'VERTICAL_SPREAD', label: 'Vertical' },
            { id: 'IRON_CONDOR', label: 'Iron Condor' }, { id: 'STRADDLE_STRANGLE', label: 'Straddle' },
            { id: 'LEAPS', label: 'LEAPS' }, { id: 'OTHER', label: 'Other' }
        ];

        const TIME_FILTERS = [
            { id: 'ALL', label: '全部' }, { id: 'TODAY', label: '今日' }, { id: 'WEEK', label: '本週' },
            { id: 'MONTH', label: '本月' }, { id: 'YEAR', label: '今年' }, { id: 'CUSTOM', label: '自訂' },
        ];

        // --- 輔助函數 ---
        const generateOptionCode = (symbol, expiryStr, strike, type) => {
            if (!symbol || !expiryStr || !strike || !type) return 'Unknown';
            const dateParts = expiryStr.split('-');
            let dateCode = '';
            if (dateParts.length === 3) {
                const yy = dateParts[0].slice(2); const mm = dateParts[1]; const dd = dateParts[2];
                dateCode = `${yy}${mm}${dd}`;
            } else { dateCode = expiryStr.replace(/-/g, '').slice(2); }
            const typeCode = type === 'CALL' ? 'C' : 'P';
            return `${symbol.toUpperCase()} ${dateCode} ${strike}${typeCode}`;
        };

        const calculatePnL = (trade, exitPriceOverride = null) => {
            const entryPrice = Math.abs(parseFloat(trade.entryPrice || 0));
            const exitPrice = exitPriceOverride !== null ? Math.abs(parseFloat(exitPriceOverride)) : Math.abs(parseFloat(trade.exitPrice || 0));
            const quantity = parseInt(trade.quantity || 0);
            const multiplier = parseInt(trade.multiplier || 100);
            const entryFees = Math.abs(parseFloat(trade.fees || 0));
            const exitFees = Math.abs(parseFloat(trade.exitFees || 0));
            let grossPnL = 0;
            if (trade.side === 'BUY') grossPnL = (exitPrice - entryPrice) * quantity * multiplier;
            else grossPnL = (entryPrice - exitPrice) * quantity * multiplier;
            return grossPnL - (entryFees + exitFees);
        };

        const getLocalDateString = (dateObj = new Date()) => {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const getActiveFilterLabel = (filter, customRange) => {
            const now = new Date(); const year = now.getFullYear(); const month = now.getMonth() + 1; const date = now.getDate();
            switch (filter) {
                case 'ALL': return '顯示所有歷史交易';
                case 'TODAY': return `${year}年${month}月${date}日`;
                case 'WEEK': {
                    const day = now.getDay(); const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                    const start = new Date(now); start.setDate(diff);
                    const end = new Date(start); end.setDate(start.getDate() + 6);
                    const format = (d) => `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
                    return `${format(start)} - ${format(end)}`;
                }
                case 'MONTH': return `${year}年${month}月`;
                case 'YEAR': return `${year}年`;
                case 'CUSTOM': return `${customRange.start} 至 ${customRange.end}`;
                default: return '';
            }
        };

        const isDateInRange = (targetDateStr, range, customStart, customEnd) => {
            if (!targetDateStr) return false;
            const target = new Date(targetDateStr).setHours(0,0,0,0); const today = new Date().setHours(0,0,0,0);
            const d = new Date(); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const startOfWeek = new Date(d.setDate(diff)).setHours(0,0,0,0);
            const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).getTime();
            const startOfYear = new Date(new Date().getFullYear(), 0, 1).getTime();
            switch (range) {
                case 'ALL': return true; case 'TODAY': return target === today;
                case 'WEEK': return target >= startOfWeek; case 'MONTH': return target >= startOfMonth;
                case 'YEAR': return target >= startOfYear;
                case 'CUSTOM':
                    if (!customStart || !customEnd) return true;
                    const start = new Date(customStart).setHours(0,0,0,0); const end = new Date(customEnd).setHours(0,0,0,0);
                    return target >= start && target <= end;
                default: return true;
            }
        };

        const fetchStockPrice = async (symbol, apiKey) => {
            if (!apiKey) throw new Error("未設定 API Key");
            try {
                const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apiKey}`);
                if (!response.ok) throw new Error("網絡請求失敗");
                const data = await response.json();
                if (data.c === 0 && data.d === null) throw new Error("無效代碼或限制");
                return data.c;
            } catch (error) { console.error("API Error:", error); throw error; }
        };

        // --- App Component ---
        function App() {
            const [currentView, setCurrentView] = useState('JOURNAL');
            const [trades, setTrades] = useState(() => {
                try { return JSON.parse(localStorage.getItem('option_trades_v1')) || []; } catch { return []; }
            });
            const [userSettings, setUserSettings] = useState(() => {
                try { return JSON.parse(localStorage.getItem('option_app_settings_v1')) || DEFAULT_SETTINGS; } catch { return DEFAULT_SETTINGS; }
            });
            const [isLoadingPrice, setIsLoadingPrice] = useState(false);
            const [showInstallPrompt, setShowInstallPrompt] = useState(false);

            useEffect(() => {
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
                if (!isStandalone && !sessionStorage.getItem('pwa_prompt_seen')) {
                    const timer = setTimeout(() => { setShowInstallPrompt(true); sessionStorage.setItem('pwa_prompt_seen', 'true'); }, 2000);
                    return () => clearTimeout(timer);
                }
            }, []);

            const symbolHistory = useMemo(() => {
                const defaults = ['AAPL', 'TSLA', 'NVDA', 'AMD', 'MSFT', 'SPY', 'QQQ', 'IWM', 'META', 'GOOGL', 'AMZN', 'NFLX'];
                const userSymbols = trades.map(t => t.symbol);
                const unique = new Set([...defaults, ...userSymbols]);
                return Array.from(unique).sort();
            }, [trades]);

            const [isFormOpen, setIsFormOpen] = useState(false);
            const [editingTradeData, setEditingTradeData] = useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [closingTrade, setClosingTrade] = useState(null);
            const [deleteTargetId, setDeleteTargetId] = useState(null);
            const [isLongAccountOpen, setIsLongAccountOpen] = useState(true);
            const [isShortAccountOpen, setIsShortAccountOpen] = useState(true);
            const [filterStatus, setFilterStatus] = useState('ALL'); 
            const [timeFilter, setTimeFilter] = useState('ALL'); 
            const [customDateRange, setCustomDateRange] = useState({ start: getLocalDateString(), end: getLocalDateString() });

            useEffect(() => { localStorage.setItem('option_trades_v1', JSON.stringify(trades)); }, [trades]);
            useEffect(() => { localStorage.setItem('option_app_settings_v1', JSON.stringify(userSettings)); }, [userSettings]);

            useEffect(() => {
                const todayStr = getLocalDateString();
                const needsUpdate = trades.some(t => t.status === 'OPEN' && t.side === 'SELL' && t.expiry < todayStr);
                if (needsUpdate) {
                    const nextTrades = trades.map(t => {
                        if (t.status === 'OPEN' && t.side === 'SELL' && t.expiry < todayStr) {
                            const netPnL = (t.entryPrice * t.quantity * (t.multiplier || 100)) - (t.fees || 0);
                            return { ...t, status: 'CLOSED', exitDate: t.expiry, exitPrice: 0, exitFees: 0, pnl: netPnL, notes: (t.notes ? t.notes + ' ' : '') + '[自動到期歸零]' };
                        }
                        return t;
                    });
                    setTrades(nextTrades);
                }
            }, [trades]);

            const handleExportData = () => {
                const data = { trades, userSettings, version: '1.3', exportDate: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `option_tracker_backup_${getLocalDateString()}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            };

            const handleImportData = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.trades && Array.isArray(data.trades)) {
                            if(window.confirm(`確定要匯入備份嗎？`)) {
                                setTrades(data.trades);
                                if(data.userSettings) setUserSettings(data.userSettings);
                                alert('還原成功！'); setIsSettingsOpen(false);
                            }
                        } else { alert('格式錯誤'); }
                    } catch (err) { alert('讀取失敗'); }
                };
                reader.readAsText(file); e.target.value = null;
            };

            const handleUpdateCurrentPrice = async (trade) => {
                if (!userSettings.finnhubApiKey) { alert("請先至設定輸入 API Key"); setIsSettingsOpen(true); return; }
                setIsLoadingPrice(true);
                try {
                    const price = await fetchStockPrice(trade.symbol, userSettings.finnhubApiKey);
                    const updatedTrades = trades.map(t => t.id === trade.id ? { ...t, underlyingPrice: price } : t);
                    setTrades(updatedTrades);
                    alert(`${trade.symbol} 現價: $${price}`);
                } catch (e) { alert(`更新失敗: ${e.message}`); } finally { setIsLoadingPrice(false); }
            };

            const saveTrade = (tradeData) => {
                if (editingTradeData) {
                    setTrades(prev => prev.map(t => {
                        if (t.id === tradeData.id) {
                            const updated = { ...t, ...tradeData };
                            if (updated.status === 'CLOSED') updated.pnl = calculatePnL(updated);
                            return updated;
                        }
                        return t;
                    }));
                    setEditingTradeData(null);
                } else { setTrades([tradeData, ...trades]); setIsFormOpen(false); }
            };

            const handleClosePosition = (closedTrade) => { setTrades(trades.map(t => t.id === closedTrade.id ? closedTrade : t)); setClosingTrade(null); };
            const confirmDelete = () => { if (deleteTargetId) { setTrades(trades.filter(t => t.id !== deleteTargetId)); setDeleteTargetId(null); } };
            
            const formatMoney = (amount, forceOriginal = false) => {
                if (amount === undefined || amount === null) return '-';
                if (forceOriginal || userSettings.currency.rate === 1) return `$${amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                const converted = amount * userSettings.currency.rate;
                return `${userSettings.currency.symbol}${converted.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            };

            const filteredTrades = useMemo(() => {
                return trades.filter(t => {
                    const dateToCheck = t.status === 'CLOSED' ? t.exitDate : t.entryDate;
                    if (!isDateInRange(dateToCheck, timeFilter, customDateRange.start, customDateRange.end)) return false;
                    if (currentView === 'JOURNAL' && filterStatus !== 'ALL' && t.status !== filterStatus) return false;
                    return true;
                });
            }, [trades, filterStatus, timeFilter, customDateRange, currentView]);

            const longTrades = useMemo(() => filteredTrades.filter(t => t.side === 'BUY'), [filteredTrades]);
            const shortTrades = useMemo(() => filteredTrades.filter(t => t.side === 'SELL'), [filteredTrades]);
            
            const globalStats = useMemo(() => {
                const closed = filteredTrades.filter(t => t.status === 'CLOSED');
                const totalPnL = closed.reduce((acc, curr) => acc + (curr.pnl || 0), 0);
                const wins = closed.filter(t => (t.pnl || 0) > 0).length;
                const winRate = closed.length > 0 ? (wins / closed.length) * 100 : 0;
                return { totalPnL, winRate, openCount: filteredTrades.filter(t => t.status === 'OPEN').length };
            }, [filteredTrades]);

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans pb-24 selection:bg-blue-100">
                    <header className="bg-white shadow-sm sticky top-0 z-20 border-b border-gray-100">
                        <div className="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center space-x-2">
                                <div className="bg-blue-600 p-2 rounded-lg text-white shadow-sm">{currentView === 'JOURNAL' ? <TrendingUp size={20} /> : <BarChart2 size={20} />}</div>
                                <div><h1 className="text-lg font-bold text-gray-900 leading-tight">{currentView === 'JOURNAL' ? '期權記帳' : '統計分析'}</h1><div className="text-xs text-gray-500">{currentView === 'JOURNAL' ? 'Long/Short 管理' : '績效總覽'}</div></div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors flex items-center gap-1 text-sm font-medium"><Settings size={18} /><span className="hidden sm:inline">{userSettings.currency.code}</span></button>
                                {currentView === 'JOURNAL' && <button onClick={() => setIsFormOpen(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg flex items-center gap-2 text-sm font-medium shadow-sm active:scale-95 transition-transform"><Plus size={16} /><span className="hidden sm:inline">新增</span><span className="sm:hidden">新增</span></button>}
                            </div>
                        </div>
                    </header>

                    {showInstallPrompt && (
                        <div className="fixed top-20 left-4 right-4 z-50 bg-gray-900 text-white p-4 rounded-xl shadow-xl flex items-start gap-3 animate-in slide-in-from-top-5">
                            <div className="bg-gray-800 p-2 rounded-lg"><Share size={20} /></div>
                            <div className="flex-1"><h3 className="font-bold text-sm">安裝獲得最佳體驗</h3><p className="text-xs text-gray-400 mt-1">點擊瀏覽器下方分享鈕，選擇「加入主畫面」。</p></div>
                            <button onClick={() => setShowInstallPrompt(false)} className="text-gray-400 hover:text-white"><X size={18}/></button>
                        </div>
                    )}

                    <main className="max-w-4xl mx-auto px-4 py-4 space-y-4">
                        {userSettings.currency.code !== 'USD' && (
                            <div className="bg-indigo-50 border border-indigo-100 text-indigo-700 px-3 py-2 rounded-lg text-xs flex items-center justify-between">
                                <div className="flex items-center gap-1"><Globe size={12} /><span>{userSettings.currency.name} ({userSettings.currency.rate})</span></div>
                                <button onClick={() => setIsSettingsOpen(true)} className="underline hover:text-indigo-900">更改</button>
                            </div>
                        )}

                        <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-2 sm:p-3 space-y-2">
                            <div className="flex items-center gap-2 overflow-x-auto pb-1 no-scrollbar">
                                <Calendar size={16} className="text-gray-400 shrink-0" />
                                <div className="flex bg-gray-100 p-1 rounded-lg shrink-0">
                                    {TIME_FILTERS.map(tf => (
                                        <button key={tf.id} onClick={() => setTimeFilter(tf.id)} className={`px-3 py-1 text-xs font-medium rounded-md whitespace-nowrap transition-all ${timeFilter === tf.id ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>{tf.label}</button>
                                    ))}
                                </div>
                            </div>
                            {timeFilter !== 'ALL' && timeFilter !== 'CUSTOM' && <div className="text-xs text-gray-500 pl-7 pt-1 animate-in fade-in">當前：<span className="font-medium text-gray-800">{getActiveFilterLabel(timeFilter)}</span></div>}
                            {timeFilter === 'CUSTOM' && <div className="flex items-center gap-2 pt-2 border-t border-gray-100 animate-in slide-in-from-top-2"><span className="text-xs text-gray-500">範圍:</span><input type="date" value={customDateRange.start} onChange={(e) => setCustomDateRange({...customDateRange, start: e.target.value})} className="border border-gray-300 rounded px-2 py-1 text-xs" /><span className="text-gray-400">-</span><input type="date" value={customDateRange.end} onChange={(e) => setCustomDateRange({...customDateRange, end: e.target.value})} className="border border-gray-300 rounded px-2 py-1 text-xs" /></div>}
                        </div>

                        {currentView === 'JOURNAL' ? (
                            <>
                                <div className="grid grid-cols-3 gap-2 sm:gap-4">
                                    <StatCard title="總淨利" value={formatMoney(globalStats.totalPnL)} isMoney color={globalStats.totalPnL >= 0 ? 'text-green-600' : 'text-red-600'} icon={<DollarSign size={16} />} />
                                    <StatCard title="總勝率" value={`${globalStats.winRate.toFixed(1)}%`} color="text-blue-600" icon={<PieChart size={16} />} />
                                    <StatCard title="總持倉" value={globalStats.openCount} color="text-orange-600" icon={<Layers size={16} />} />
                                </div>
                                <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-2 sm:p-3">
                                    <div className="flex bg-gray-100 p-1 rounded-lg">
                                        {['ALL', 'OPEN', 'CLOSED'].map(status => (
                                            <button key={status} onClick={() => setFilterStatus(status)} className={`flex-1 px-3 py-1 text-xs font-medium rounded-md transition-all ${filterStatus === status ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>{status === 'ALL' ? '全部' : status === 'OPEN' ? '持倉' : '已平倉'}</button>
                                        ))}
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    <AccountSection title="買方帳戶 (Long)" trades={longTrades} isOpen={isLongAccountOpen} onToggle={() => setIsLongAccountOpen(!isLongAccountOpen)} theme="blue" icon={<TrendingUp size={18} />} formatMoney={formatMoney} onEdit={setEditingTradeData} onDelete={(id) => setDeleteTargetId(id)} onClosePos={setClosingTrade} onUpdatePrice={handleUpdateCurrentPrice} />
                                    <AccountSection title="賣方帳戶 (Short)" trades={shortTrades} isOpen={isShortAccountOpen} onToggle={() => setIsShortAccountOpen(!isShortAccountOpen)} theme="purple" icon={<Shield size={18} />} formatMoney={formatMoney} onEdit={setEditingTradeData} onDelete={(id) => setDeleteTargetId(id)} onClosePos={setClosingTrade} onUpdatePrice={handleUpdateCurrentPrice} />
                                </div>
                            </>
                        ) : (
                            <StatsView trades={filteredTrades} formatMoney={formatMoney} initialCapital={userSettings.initialCapital} />
                        )}
                    </main>
                    
                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3 flex justify-around items-center z-30 pb-safe">
                        <button onClick={() => setCurrentView('JOURNAL')} className={`flex flex-col items-center gap-1 transition-colors ${currentView === 'JOURNAL' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}><LayoutList size={24} strokeWidth={currentView === 'JOURNAL' ? 2.5 : 2} /><span className="text-[10px] font-bold">記帳</span></button>
                        <button onClick={() => setCurrentView('STATS')} className={`flex flex-col items-center gap-1 transition-colors ${currentView === 'STATS' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}><BarChart2 size={24} strokeWidth={currentView === 'STATS' ? 2.5 : 2} /><span className="text-[10px] font-bold">統計</span></button>
                    </nav>

                    {(isFormOpen || editingTradeData) && <Modal title={editingTradeData ? "修改交易" : "新增交易"} onClose={() => { setIsFormOpen(false); setEditingTradeData(null); }}><TradeForm initialData={editingTradeData} onSubmit={saveTrade} onCancel={() => { setIsFormOpen(false); setEditingTradeData(null); }} symbolHistory={symbolHistory} /></Modal>}
                    {closingTrade && <Modal title="平倉 / 結算" onClose={() => setClosingTrade(null)}><ClosePositionForm trade={closingTrade} onSubmit={handleClosePosition} onCancel={() => setClosingTrade(null)} /></Modal>}
                    {deleteTargetId && <Modal title="確認刪除" onClose={() => setDeleteTargetId(null)}><div className="space-y-6 py-2"><div className="flex flex-col items-center text-center gap-2"><div className="p-3 bg-red-100 rounded-full text-red-600 mb-1"><AlertCircle size={32} /></div><h4 className="text-lg font-bold text-gray-900">確定要刪除嗎？</h4><p className="text-gray-500 text-sm">此操作將永久刪除這筆交易記錄，無法復原。</p></div><div className="flex gap-3"><button onClick={() => setDeleteTargetId(null)} className="flex-1 py-2.5 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">取消</button><button onClick={confirmDelete} className="flex-1 py-2.5 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 shadow-sm">確認刪除</button></div></div></Modal>}
                    {isSettingsOpen && <Modal title="設定" onClose={() => setIsSettingsOpen(false)}><AppSettingsForm settings={userSettings} onSave={(newSettings) => setUserSettings(newSettings)} onCancel={() => setIsSettingsOpen(false)} onExport={handleExportData} onImport={handleImportData} /></Modal>}
                    {isLoadingPrice && <div className="fixed inset-0 bg-black/30 z-50 flex items-center justify-center"><div className="bg-white p-4 rounded-xl flex items-center gap-3 shadow-lg"><RefreshCcw className="animate-spin text-blue-600" size={24} /><span className="text-sm font-bold">更新股價中...</span></div></div>}
                </div>
            );
        }

        // --- Sub Components ---
        function StatsView({ trades, formatMoney, initialCapital }) {
            const chartData = useMemo(() => {
                const closedTrades = trades.filter(t => t.status === 'CLOSED').sort((a, b) => new Date(a.exitDate) - new Date(b.exitDate));
                let cumulative = 0;
                const dataPoints = closedTrades.map(t => { cumulative += t.pnl; return { date: t.exitDate.slice(5).replace('-', '/'), value: cumulative }; });
                if (dataPoints.length > 0) dataPoints.unshift({ date: 'Start', value: 0 });
                return dataPoints;
            }, [trades]);

            const symbolStats = useMemo(() => {
                const map = {};
                trades.filter(t => t.status === 'CLOSED').forEach(t => {
                    const k = t.symbol;
                    if (!map[k]) map[k] = { key: k, pnl: 0, wins: 0, total: 0, longPnl: 0, shortPnl: 0 };
                    map[k].total++; map[k].pnl += t.pnl;
                    if (t.pnl > 0) map[k].wins++;
                    if (t.side === 'BUY') map[k].longPnl += t.pnl; else map[k].shortPnl += t.pnl;
                });
                return Object.values(map).sort((a, b) => b.pnl - a.pnl);
            }, [trades]);

            const strategyStats = useMemo(() => {
                const map = {};
                trades.filter(t => t.status === 'CLOSED').forEach(t => {
                    const k = t.strategy || 'OTHER';
                    const label = STRATEGIES.find(s => s.id === k)?.label || '其他';
                    if (!map[k]) map[k] = { key: k, label, pnl: 0, wins: 0, total: 0 };
                    map[k].total++; map[k].pnl += t.pnl;
                    if (t.pnl > 0) map[k].wins++;
                });
                return Object.values(map).sort((a, b) => b.pnl - a.pnl);
            }, [trades]);

            const totalNetPnL = symbolStats.reduce((acc, curr) => acc + curr.pnl, 0);
            const totalTradesCount = symbolStats.reduce((acc, curr) => acc + curr.total, 0);
            const totalWins = symbolStats.reduce((acc, curr) => acc + curr.wins, 0);
            const avgWinRate = totalTradesCount > 0 ? (totalWins / totalTradesCount) * 100 : 0;
            const returnOnInvestment = initialCapital > 0 ? (totalNetPnL / initialCapital) * 100 : 0;

            return (
                <div className="space-y-6 animate-in fade-in duration-300">
                    <div className="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                        <div className="p-5 bg-gradient-to-br from-gray-900 to-gray-800 text-white">
                            <div className="flex justify-between items-start mb-4">
                                <div><p className="text-gray-400 text-xs mb-1">本期累計損益</p><h2 className={`text-3xl font-bold ${totalNetPnL >= 0 ? 'text-green-400' : 'text-red-400'}`}>{totalNetPnL > 0 ? '+' : ''}{formatMoney(totalNetPnL)}</h2></div>
                                <div className="text-right"><p className="text-gray-400 text-xs mb-1">累計收益率 (ROI)</p><h2 className={`text-3xl font-bold ${returnOnInvestment >= 0 ? 'text-green-400' : 'text-red-400'}`}>{returnOnInvestment > 0 ? '+' : ''}{returnOnInvestment.toFixed(2)}%</h2>{initialCapital === 0 && <span className="text-[10px] text-gray-500">(請設定本金)</span>}</div>
                            </div>
                            <div className="flex gap-4 mb-4 text-sm text-gray-400 border-t border-gray-700 pt-3"><div>勝率 <span className="text-white font-bold">{avgWinRate.toFixed(1)}%</span></div><div>交易數 <span className="text-white font-bold">{totalTradesCount}</span></div></div>
                            <div className="h-32 w-full"><SimpleLineChart data={chartData} height={120} /></div>
                        </div>
                    </div>

                    {/* 1. 標的績效 (優先) */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div className="p-3 border-b border-gray-100 bg-gray-50 flex items-center gap-2"><LayoutList size={16} className="text-gray-500" /><h3 className="font-bold text-gray-800 text-sm">標的績效 (Symbol)</h3></div>
                        {symbolStats.length === 0 ? <div className="p-8 text-center text-gray-400 text-xs">無數據</div> : <div className="divide-y divide-gray-100">{symbolStats.map(item => {
                            const winRate = item.total > 0 ? (item.wins / item.total) * 100 : 0;
                            return (
                                <div key={item.key} className="p-4 hover:bg-gray-50 transition-colors">
                                    <div className="flex justify-between items-center mb-2"><div className="flex items-center gap-2"><span className="font-bold text-lg text-gray-900 w-16">{item.key}</span><span className="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">{item.total} 筆</span></div><div className={`font-bold ${item.pnl >= 0 ? 'text-green-600' : 'text-red-600'}`}>{item.pnl > 0 ? '+' : ''}{formatMoney(item.pnl)}</div></div>
                                    <div className="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden"><div className={`h-full rounded-full ${winRate >= 50 ? 'bg-blue-500' : 'bg-orange-400'}`} style={{ width: `${winRate}%` }}></div></div>
                                </div>
                            );
                        })}</div>}
                    </div>

                    {/* 2. 策略績效 (次要) */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div className="p-3 border-b border-gray-100 bg-gray-50 flex items-center gap-2"><Layers size={16} className="text-gray-500" /><h3 className="font-bold text-gray-800 text-sm">策略績效 (Strategy)</h3></div>
                        <div className="divide-y divide-gray-100">{strategyStats.length === 0 ? <div className="p-4 text-center text-gray-400 text-xs">無數據</div> : strategyStats.map(item => {
                            const wr = item.total > 0 ? (item.wins / item.total) * 100 : 0;
                            return (
                                <div key={item.key} className="p-3 flex items-center justify-between text-sm"><div className="flex flex-col"><span className="font-bold text-gray-800">{item.label}</span><span className="text-xs text-gray-400">{item.total} 筆 • 勝率 {wr.toFixed(0)}%</span></div><div className={`font-bold ${item.pnl >= 0 ? 'text-green-600' : 'text-red-600'}`}>{item.pnl > 0 ? '+' : ''}{formatMoney(item.pnl)}</div></div>
                            );
                        })}</div>
                    </div>
                </div>
            );
        }

        function SimpleLineChart({ data, height = 150 }) {
            if (!data || data.length < 2) return <div className="h-32 flex items-center justify-center text-gray-400 text-xs">數據不足以繪製圖表</div>;
            const maxVal = Math.max(...data.map(d => d.value), 0); const minVal = Math.min(...data.map(d => d.value), 0); const range = maxVal - minVal || 1;
            const points = data.map((d, i) => { const x = (i / (data.length - 1)) * 100; const y = 100 - ((d.value - minVal) / range) * 100; return `${x},${y}`; }).join(' ');
            const zeroY = 100 - ((0 - minVal) / range) * 100;
            return (<div className="w-full relative" style={{ height: `${height}px` }}><svg viewBox="0 0 100 100" preserveAspectRatio="none" className="w-full h-full overflow-visible">{minVal < 0 && maxVal > 0 && <line x1="0" y1={zeroY} x2="100" y2={zeroY} stroke="#4b5563" strokeWidth="0.5" strokeDasharray="2" />}<polyline fill="none" stroke="#3b82f6" strokeWidth="1.5" points={points} strokeLinecap="round" strokeLinejoin="round" /></svg><div className="absolute top-0 left-0 text-[10px] text-gray-500">{data[0].date}</div><div className="absolute bottom-0 right-0 text-[10px] text-gray-500">{data[data.length-1].date}</div></div>);
        }

        function AppSettingsForm({ settings, onSave, onCancel, onExport, onImport }) {
            const [selectedCode, setSelectedCode] = useState(settings.currency.code);
            const [customRate, setCustomRate] = useState(settings.currency.rate);
            const [capital, setCapital] = useState(settings.initialCapital || 10000);
            const [apiKey, setApiKey] = useState(settings.finnhubApiKey || '');
            const fileInputRef = useRef(null);
            const handleCurrencyChange = (e) => { const newCode = e.target.value; setSelectedCode(newCode); const option = CURRENCY_OPTIONS.find(c => c.code === newCode); if (option) setCustomRate(option.defaultRate); };
            const handleSave = (e) => { e.preventDefault(); const option = CURRENCY_OPTIONS.find(c => c.code === selectedCode); onSave({ currency: { code: selectedCode, symbol: option ? option.symbol : '$', rate: parseFloat(customRate), name: option ? option.name : selectedCode }, initialCapital: parseFloat(capital), finnhubApiKey: apiKey }); onCancel(); };
            return (
                <div className="space-y-6"><form onSubmit={handleSave} className="space-y-4"><div className="space-y-2"><h4 className="text-sm font-bold text-gray-900 flex items-center gap-2"><Wallet size={16}/> 帳戶設定</h4><div><label className="block text-xs font-medium text-gray-700 mb-1">初始本金</label><input type="number" required value={capital} onChange={(e) => setCapital(e.target.value)} className="w-full border border-gray-300 rounded-lg p-2 text-sm" /></div></div><div className="space-y-2"><h4 className="text-sm font-bold text-gray-900 flex items-center gap-2"><Key size={16}/> API 設定</h4><div><label className="block text-xs font-medium text-gray-700 mb-1">API Key</label><input type="text" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="w-full border border-gray-300 rounded-lg p-2 text-sm" placeholder="Finnhub API Key" /></div></div><div className="border-t border-gray-100 pt-4 space-y-2"><h4 className="text-sm font-bold text-gray-900 flex items-center gap-2"><Globe size={16}/> 顯示貨幣</h4><div><select value={selectedCode} onChange={handleCurrencyChange} className="w-full border border-gray-300 rounded-lg p-2 text-sm mb-2">{CURRENCY_OPTIONS.map(opt => <option key={opt.code} value={opt.code}>{opt.name}</option>)}</select><div className="flex gap-2 items-center"><span className="text-gray-500 text-xs">匯率 1 USD =</span><input type="number" step="0.01" required value={customRate} onChange={(e) => setCustomRate(e.target.value)} className="flex-1 border border-gray-300 rounded-lg p-2 text-sm" /></div></div></div><div className="flex gap-3 pt-2"><button type="submit" className="flex-1 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-medium w-full">保存設定</button></div></form><div className="border-t border-gray-100 pt-4 space-y-3"><h4 className="text-sm font-bold text-gray-900 flex items-center gap-2"><FileJson size={16}/> 資料管理</h4><div className="grid grid-cols-2 gap-3"><button onClick={onExport} className="flex items-center justify-center gap-2 py-2.5 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 text-gray-700"><Download size={16} /> 匯出</button><button onClick={() => fileInputRef.current.click()} className="flex items-center justify-center gap-2 py-2.5 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 text-gray-700"><Upload size={16} /> 匯入</button><input type="file" ref={fileInputRef} onChange={onImport} accept=".json" className="hidden" /></div></div></div>
            );
        }

        function TradeForm({ onSubmit, onCancel, initialData, symbolHistory }) {
            const [formData, setFormData] = useState({ symbol: '', side: 'BUY', optionType: 'CALL', strike: '', expiry: '', strategy: 'LONG_CALL', entryDate: getLocalDateString(), quantity: 1, entryPrice: '', fees: 0, multiplier: 100, notes: '' });
            useEffect(() => { if (initialData) { setFormData({ ...initialData, entryPrice: initialData.entryPrice, quantity: initialData.quantity, fees: initialData.fees, multiplier: initialData.multiplier || 100, strike: initialData.strike, strategy: initialData.strategy || 'LONG_CALL' }); } }, [initialData]);
            const handleSubmit = (e) => { e.preventDefault(); if (!formData.symbol || !formData.strike || !String(formData.entryPrice)) return; const tradeData = { ...formData, id: initialData ? initialData.id : crypto.randomUUID(), status: initialData ? initialData.status : 'OPEN', symbol: formData.symbol.toUpperCase(), strike: parseFloat(formData.strike), quantity: parseInt(formData.quantity), entryPrice: Math.abs(parseFloat(formData.entryPrice)), fees: Math.abs(parseFloat(formData.fees || 0)), multiplier: parseInt(formData.multiplier || 100), createdAt: initialData ? initialData.createdAt : new Date().toISOString() }; onSubmit(tradeData); };
            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
            const SideToggle = () => (<div className="flex rounded-lg overflow-hidden border border-gray-200 w-full h-10"><button type="button" onClick={() => setFormData(p => ({...p, side: 'BUY'}))} className={`flex-1 font-bold text-sm transition-colors ${formData.side === 'BUY' ? 'bg-blue-600 text-white' : 'bg-white text-gray-500 hover:bg-gray-50'}`}>BUY (買方)</button><div className="w-px bg-gray-200"></div><button type="button" onClick={() => setFormData(p => ({...p, side: 'SELL'}))} className={`flex-1 font-bold text-sm transition-colors ${formData.side === 'SELL' ? 'bg-purple-600 text-white' : 'bg-white text-gray-500 hover:bg-gray-50'}`}>SELL (賣方)</button></div>);
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-2 gap-3"><div><label className="block text-xs font-medium text-gray-700 mb-1">標的 (Symbol)</label><input type="text" name="symbol" required list="symbol-options" placeholder="如 AAPL" className="w-full border border-gray-300 rounded-lg p-2 text-sm uppercase" value={formData.symbol} onChange={handleChange} autoComplete="off" /><datalist id="symbol-options">{symbolHistory && symbolHistory.map((s) => (<option key={s} value={s} />))}</datalist></div><div><label className="block text-xs font-medium text-gray-700 mb-1">開倉日期</label><input type="date" name="entryDate" required className="w-full border border-gray-300 rounded-lg p-2 text-sm" value={formData.entryDate} onChange={handleChange} /></div></div>
                    <div className="grid grid-cols-2 gap-3"><SideToggle /><div className="flex rounded-lg overflow-hidden border border-gray-200 w-full h-10"><select name="optionType" value={formData.optionType} onChange={handleChange} className="w-full h-full bg-white border-none text-sm font-bold text-center text-gray-700 focus:ring-0"><option value="CALL">CALL (看漲)</option><option value="PUT">PUT (看跌)</option></select></div></div>
                    <div><label className="block text-xs font-medium text-gray-700 mb-1">交易策略</label><select name="strategy" value={formData.strategy} onChange={handleChange} className="w-full border border-gray-300 rounded-lg p-2 text-sm bg-gray-50">{STRATEGIES.map(s => (<option key={s.id} value={s.id}>{s.label}</option>))}</select></div>
                    <div className="grid grid-cols-3 gap-3"><div className="col-span-1"><label className="block text-xs font-medium text-gray-700 mb-1">行權價</label><input type="number" step="0.5" name="strike" required className="w-full border border-gray-300 rounded-lg p-2 text-sm" value={formData.strike} onChange={handleChange} /></div><div className="col-span-2"><label className="block text-xs font-medium text-gray-700 mb-1">到期日</label><input type="date" name="expiry" required className="w-full border border-gray-300 rounded-lg p-2 text-sm" value={formData.expiry} onChange={handleChange} /></div></div>
                    <div className="grid grid-cols-3 gap-3"><div><label className="block text-xs font-medium text-gray-700 mb-1">權利金</label><input type="number" step="0.01" name="entryPrice" required placeholder="0.00" className="w-full border border-gray-300 rounded-lg p-2 text-sm" value={formData.entryPrice} onChange={handleChange} /></div><div><label className="block text-xs font-medium text-gray-700 mb-1">數量</label><input type="number" name="quantity" min="1" required className="w-full border border-gray-300 rounded-lg p-2 text-sm" value={formData.quantity} onChange={handleChange} /></div><div><label className="block text-xs font-medium text-gray-700 mb-1">總佣金</label><input type="number" step="0.1" name="fees" className="w-full border border-gray-300 rounded-lg p-2 text-sm" value={formData.fees} onChange={handleChange} /></div></div>
                    <div className="pt-2 border-t border-gray-100"><details className="text-xs text-gray-500 cursor-pointer"><summary className="mb-2">高級設置</summary><div className="flex items-center gap-2"><label>每合約股數:</label><input type="number" name="multiplier" value={formData.multiplier} onChange={handleChange} className="border rounded p-1 w-20" /></div></details></div>
                    <div><label className="block text-xs font-medium text-gray-700 mb-1">備註</label><textarea name="notes" rows="2" className="w-full border border-gray-300 rounded-lg p-2 text-sm resize-none" value={formData.notes} onChange={handleChange}></textarea></div>
                    <div className="flex gap-3 pt-2"><button type="button" onClick={onCancel} className="flex-1 py-2.5 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">取消</button><button type="submit" className={`flex-1 py-2.5 text-white rounded-lg text-sm font-medium ${formData.side === 'BUY' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-purple-600 hover:bg-purple-700'}`}>{initialData ? '更新交易' : '保存交易'}</button></div>
                </form>
            );
        }

        function AccountSection({ title, trades, isOpen, onToggle, theme, icon, formatMoney, onEdit, onDelete, onClosePos, onUpdatePrice }) {
            const stats = useMemo(() => {
                const closed = trades.filter(t => t.status === 'CLOSED'); const open = trades.filter(t => t.status === 'OPEN');
                const pnl = closed.reduce((acc, curr) => acc + (curr.pnl || 0), 0);
                const wins = closed.filter(t => (t.pnl || 0) > 0).length;
                const rate = closed.length > 0 ? (wins / closed.length) * 100 : 0;
                return { pnl, rate, openCount: open.length };
            }, [trades]);
            const pnlColor = stats.pnl >= 0 ? 'text-green-600' : 'text-red-600';
            const borderColor = theme === 'blue' ? 'border-blue-200' : 'border-purple-200';
            const headerBg = theme === 'blue' ? 'bg-blue-50/80' : 'bg-purple-50/80';
            const textColor = theme === 'blue' ? 'text-blue-900' : 'text-purple-900';
            return (
                <div className={`bg-white rounded-xl shadow-sm border ${borderColor} overflow-hidden`}>
                    <div onClick={onToggle} className={`p-3 sm:p-4 flex items-center justify-between cursor-pointer hover:bg-opacity-100 transition-colors ${headerBg}`}>
                        <div className="flex items-center gap-3"><div className={`p-1.5 bg-white rounded-lg shadow-sm ${textColor}`}>{icon}</div><div><h3 className={`font-bold text-sm sm:text-base ${textColor}`}>{title}</h3><div className="flex items-center gap-2 text-[10px] sm:text-xs text-gray-500"><span>持倉: {stats.openCount}</span><span className="text-gray-300">|</span><span>勝率: {stats.rate.toFixed(0)}%</span></div></div></div>
                        <div className="flex items-center gap-3"><div className="text-right"><div className={`font-bold text-sm sm:text-base ${pnlColor}`}>{stats.pnl > 0 ? '+' : ''}{formatMoney(stats.pnl)}</div></div>{isOpen ? <ChevronDown size={18} className="text-gray-400" /> : <ChevronRight size={18} className="text-gray-400" />}</div>
                    </div>
                    {isOpen && <div className="p-2 sm:p-3 bg-white space-y-2 border-t border-gray-100">{trades.length === 0 ? <div className="text-center py-6 text-gray-400 border-2 border-dashed border-gray-100 rounded-lg"><p className="text-xs">無交易記錄</p></div> : trades.map(trade => <TradeCard key={trade.id} trade={trade} onDelete={onDelete} onEdit={onEdit} onClosePosition={onClosePos} formatMoney={formatMoney} onUpdatePrice={onUpdatePrice} />)}</div>}
                </div>
            );
        }

        function StatCard({ title, value, color, icon }) {
            return (<div className="bg-white p-3 rounded-xl shadow-sm border border-gray-100"><div className="flex justify-between items-start mb-1"><span className="text-[10px] text-gray-500 font-medium">{title}</span><div className={`p-1 rounded bg-gray-50 ${color}`}>{icon}</div></div><div className={`text-sm sm:text-base font-bold ${color} truncate`}>{value}</div></div>);
        }

        function TradeCard({ trade, onDelete, onEdit, onClosePosition, formatMoney, onUpdatePrice }) {
            const [isExpanded, setIsExpanded] = useState(false);
            const isOpen = trade.status === 'OPEN';
            const optionCode = generateOptionCode(trade.symbol, trade.expiry, trade.strike, trade.optionType);
            const pnlColor = trade.pnl >= 0 ? 'text-green-600' : 'text-red-600';
            const strategyLabel = STRATEGIES.find(s => s.id === trade.strategy)?.label || '未分類';
            const formatDate = (dateStr) => { if(!dateStr) return '-'; const date = new Date(dateStr); return date.toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' }); };
            return (
                <div className={`bg-white rounded-lg shadow-sm border border-gray-100 transition-all duration-200 overflow-hidden ${isOpen ? 'border-l-4 border-l-blue-400' : (trade.pnl >= 0 ? 'border-l-4 border-l-green-500' : 'border-l-4 border-l-red-500')}`}>
                    <div onClick={() => setIsExpanded(!isExpanded)} className="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition-colors">
                        <div className="flex flex-col gap-0.5"><div className="flex items-center gap-2"><span className="font-bold text-sm text-gray-900 font-mono tracking-tight">{optionCode}</span>{!isOpen && trade.exitPrice === 0 && trade.side === 'SELL' && <div className="w-1.5 h-1.5 rounded-full bg-green-500" title="到期歸零"></div>}</div>{!isExpanded && <div className="flex items-center gap-2"><span className="text-[10px] text-gray-400 flex items-center gap-1">{isOpen ? '持倉中' : formatDate(trade.exitDate)}</span>{trade.strategy && <span className="text-[9px] bg-gray-100 text-gray-500 px-1.5 rounded-full">{strategyLabel.split(' ')[0]}</span>}</div>}</div>
                        <div className="flex items-center gap-3"><div className="text-right">{isOpen ? <span className="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full block">OPEN</span> : <span className={`text-sm font-bold ${pnlColor} block`}>{trade.pnl > 0 ? '+' : ''}{formatMoney(trade.pnl)}</span>}</div>{isExpanded ? <ChevronDown size={16} className="text-gray-300" /> : <ChevronRight size={16} className="text-gray-300" />}</div>
                    </div>
                    {isExpanded && <div className="px-3 pb-3 pt-0 animate-in slide-in-from-top-1">
                        <div className="border-t border-gray-100 mb-3"></div>
                        <div className="mb-2 flex justify-between items-center"><span className="text-[10px] font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded flex items-center gap-1 w-fit"><Tag size={10} /> {strategyLabel}</span>{isOpen && <button onClick={(e) => {e.stopPropagation(); onUpdatePrice(trade)}} className="text-[10px] text-blue-600 flex items-center gap-1 hover:underline"><RefreshCcw size={10}/> 更新現價</button>}</div>
                        <div className="grid grid-cols-2 gap-y-2 gap-x-4 text-xs text-gray-600 mb-3">
                            <div className="flex justify-between"><span className="text-gray-400">數量</span><span className="font-medium">{trade.quantity} 張</span></div><div className="flex justify-between"><span className="text-gray-400">到期日</span><span className="font-medium">{formatDate(trade.expiry)}</span></div><div className="flex justify-between"><span className="text-gray-400">開倉價</span><span className="font-medium">{formatMoney(trade.entryPrice, true)}</span></div><div className="flex justify-between"><span className="text-gray-400">{isOpen ? '當前價' : '平倉價'}</span><span className="font-medium">{trade.exitPrice !== undefined && trade.exitPrice !== null ? formatMoney(trade.exitPrice, true) : '-'}</span></div>
                            {trade.underlyingPrice && <div className="flex justify-between"><span className="text-gray-400">股價</span><span className="font-medium text-blue-600">${trade.underlyingPrice}</span></div>}
                            <div className="col-span-2 flex justify-between"><span className="text-gray-400">日期</span><span className="font-medium text-gray-500">{formatDate(trade.entryDate)} {isOpen ? '' : `→ ${formatDate(trade.exitDate)}`}</span></div>
                        </div>
                        {trade.notes && <div className="text-[11px] text-gray-500 bg-gray-50 p-2 rounded mb-3 border border-gray-100">{trade.notes}</div>}
                        <div className="flex justify-end gap-2"><button onClick={(e) => { e.stopPropagation(); onEdit(trade); }} className="px-2 py-1.5 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded text-xs flex items-center gap-1 transition-colors border border-gray-200"><Edit size={12} /> 修改</button><button onClick={(e) => { e.stopPropagation(); onDelete(trade.id); }} className="px-2 py-1.5 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded text-xs flex items-center gap-1 transition-colors border border-gray-200"><Trash2 size={12} /> 刪除</button>{isOpen && <button onClick={(e) => { e.stopPropagation(); onClosePosition(trade); }} className="px-3 py-1.5 bg-gray-900 hover:bg-black text-white rounded text-xs flex items-center gap-1 ml-auto shadow-sm">平倉 <ArrowRight size={12} /></button>}</div>
                    </div>}
                </div>
            );
        }

        function ClosePositionForm({ trade, onSubmit, onCancel }) {
            const [formData, setFormData] = useState({ exitDate: getLocalDateString(), exitPrice: '', exitFees: 0, notes: trade.notes || '' });
            const handleSubmit = (e) => { e.preventDefault(); if (!formData.exitPrice) return; const updatedTrade = { ...trade, status: 'CLOSED', exitPrice: Math.abs(parseFloat(formData.exitPrice)), exitFees: Math.abs(parseFloat(formData.exitFees || 0)), exitDate: formData.exitDate, notes: formData.notes }; updatedTrade.pnl = calculatePnL(updatedTrade); onSubmit(updatedTrade); };
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="bg-gray-50 p-3 rounded-lg text-sm mb-4"><div className="flex justify-between mb-1"><span className="text-gray-500">標的:</span><span className="font-bold font-mono text-gray-800">{generateOptionCode(trade.symbol, trade.expiry, trade.strike, trade.optionType)}</span></div><div className="flex justify-between"><span className="text-gray-500">開倉價 (USD):</span><span>${trade.entryPrice}</span></div></div>
                    <div className="grid grid-cols-2 gap-3"><div><label className="block text-xs font-medium text-gray-700 mb-1">平倉日期</label><input type="date" required className="w-full border border-gray-300 rounded-lg p-2 text-sm" value={formData.exitDate} onChange={(e) => setFormData({...formData, exitDate: e.target.value})} /></div><div><label className="block text-xs font-medium text-gray-700 mb-1">平倉價格 (USD)</label><input type="number" step="0.01" required placeholder="0.00" className="w-full border border-gray-300 rounded-lg p-2 text-sm" value={formData.exitPrice} onChange={(e) => setFormData({...formData, exitPrice: e.target.value})} /></div></div>
                    <div><label className="block text-xs font-medium text-gray-700 mb-1">平倉佣金 (USD)</label><input type="number" step="0.1" className="w-full border border-gray-300 rounded-lg p-2 text-sm" value={formData.exitFees} onChange={(e) => setFormData({...formData, exitFees: e.target.value})} /></div>
                    <div><label className="block text-xs font-medium text-gray-700 mb-1">更新備註</label><textarea rows="2" className="w-full border border-gray-300 rounded-lg p-2 text-sm resize-none" value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})}></textarea></div>
                    <div className="flex gap-3 pt-4"><button type="button" onClick={onCancel} className="flex-1 py-2.5 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">取消</button><button type="submit" className="flex-1 py-2.5 bg-gray-900 text-white rounded-lg text-sm font-medium hover:bg-gray-800">確認平倉</button></div>
                </form>
            );
        }

        function Modal({ title, children, onClose }) {
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-md shadow-xl overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="flex justify-between items-center p-4 border-b"><h3 className="text-lg font-bold text-gray-900">{title}</h3><button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-100"><X size={20} /></button></div>
                        <div className="p-4">{children}</div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


